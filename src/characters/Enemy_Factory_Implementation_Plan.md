# Enemy Factory Implementation Planning Document

## Prompt:
Ok. Lets focus on on the Enemy factory implementation (lets try not to break stuff).

I want to have seperate factory instances under src\characters:
Pathogen.jsx
Mutagen.jsx
InfectionVector.jsx
SupportVector.jsx

The SnakePathogen.jsx should be integrated into Pathogen.jsx, but since the snake is a special grouped meshes procedural, it should be applied similarly in all three factory instances I named above. I am trying to seperate concerns.

There must be procedural entities for all four based on the revised roster.js, but please take special not on the Mutagen.jsx on how they should look and their attack patterns:
- UV Radiation: A 10-pointed star mesh with "holy white-subtle blue" glowing material that hovers around the arena and shoots 3 constant laser beams for 4sec in non-linear alternation around the arena. The player will try to avoid these beams. This enemy cannot be killed, it enters the arena for 4 waves an leaves from the time that it is elidgible to be spawned. 
- Benzene: Should me a molecule structure that glides above the arena floor that spins and spews out toxic smoke and fire. Take reference from src\entities\TriangleBoss.jsx for the attack pattern
- X-Rays: A flashlight-like shaped mesh that appears in the arena like the src\entities\PipeBoss.jsx, but instead of emitting flying drones, it shoots lasers that are slightly slower than the player/game speed, This enemy is not mobile, the lasers should do too much damage (1 hit per tick I think would be fine), mostly status effect should be applied.
- Nitrosamines: Should me a molecule structure that attacks by slowly roaves around the arena, when agetated, then it attacks with two smoke-fire attacks in the direction of the player. If it accedentally colides with power ups, the power up should get destroyed/despawn

---
Please create a proper planning document first before making changes so that all the changes can be mapped out and revised safely. Go.

---
## Plan Overview
This planning document outlines the implementation of separate factory instances for enemy entities in the characters directory, based on the revised `roster.js`. The goal is to modularize enemy creation by type (Pathogens, Mutagens, Infection Vectors, Support Vectors) while integrating existing components like `SnakePathogen.jsx` and applying procedural grouped meshes consistently. Special attention is given to Mutagen entities with unique designs and attack patterns. All changes aim to avoid breaking existing functionality by isolating new code and using conditional logic where necessary.

Key objectives:
- Create four factory files: `Pathogen.jsx`, `Mutagen.jsx`, `InfectionVector.jsx`, `SupportVector.jsx`.
- Integrate `SnakePathogen.jsx` into `Pathogen.jsx` as a special procedural variant.
- Apply the "special grouped meshes procedural" (from SnakePathogen) to Pathogen, Mutagen, and InfectionVector factories for consistency.
- Implement procedural entities for all roster entries, with detailed Mutagen behaviors.
- Ensure procedural generation uses roster data (e.g., shape, color, stats) for dynamic creation.
- Maintain performance (low memory/draw calls) and compatibility with existing game logic (e.g., wave pacing, boss cadence).

---
### Current Wiring and Impact of PathogenFactory on New Factories

#### How PathogenFactory Currently Works and Its Relation to New Factories
- **PathogenFactory.tsx Overview**: This is an existing TypeScript file (PathogenFactory.tsx) that serves as a procedural generator for pathogen-like entities. It exports a `PathogenFromSpec` component, which takes a `spec` object (containing properties like `spikeCount`, `color`, `radius`, etc.) and generates a Three.js mesh/group for visual representation. It's designed for dynamic, tweakable pathogen visuals and is used in various places for procedural enemy rendering.
  
- **Current Usage in the Game**:
  - **RosterEnemy.jsx**: Before our changes, `RosterEnemy` (the generic enemy component for roster-based enemies) used `PathogenFromSpec` via the `factorySpec` prop to render visuals. The `factorySpec` was generated by `randomFactorySpecFromRoster` in App.jsx, which pulls from roster data but adapts it to the PathogenFactory's spec format.
  - **Other Entities**: Components like Minion.jsx, TriangleBoss.jsx, PipeBoss.jsx, etc., import and use `PathogenFromSpec` directly for their procedural meshes. This creates a consistent "pathogen-style" look across many enemies.
  - **AvatarTuner.tsx**: This page uses `PathogenFromSpec` for live-previewing and tuning procedural pathogen specs. Users can adjust sliders (e.g., spike count, colors) and see real-time changes, with the spec being exportable for use in the game.

- **Impact on New Factories (Mutagen, InfectionVector, SupportVector)**:
  - **No Direct Dependency**: The new factories (Mutagen.jsx, InfectionVector.jsx, `SupportVector.jsx`) are **independent React components** that don't rely on PathogenFactory.tsx. They use shared utilities like `createGroupedMeshes` from ProceduralUtils.js and roster data (`enemyData`) to generate meshes procedurally. For example:
    - Mutagen.jsx creates specific shapes (e.g., 10-pointed star for UV Radiation) using Three.js primitives and materials, without calling `PathogenFromSpec`.
    - InfectionVector.jsx and `SupportVector.jsx` are placeholders that could integrate with `CreatureFactory.tsx` (from CREATURE_FACTORY_CONTEXT.md) for animal-like models, but they don't touch `PathogenFactory`.
  - **Indirect Influence via RosterEnemy**: In RosterEnemy.jsx, we added logic to dispatch to the new factories based on `enemyData.type` (e.g., 'Mutagen' → `<Mutagen enemyData={...} />`). If `enemyData` is missing or doesn't match, it falls back to `PathogenFromSpec` (from PathogenFactory). This means:
    - New enemy types (Mutagens, Infection Vectors) bypass PathogenFactory entirely and use their own factories.
    - Existing or fallback enemies still use PathogenFactory, ensuring no breakage.
  - **Shared Procedural Logic**: All new factories use `createGroupedMeshes` (a simple utility for basic shapes), but `PathogenFactory` has more advanced features (e.g., spikes, nodes, animations). The new factories are simpler and type-specific, so they don't "inherit" from PathogenFactory—they're parallel implementations.
  - **Performance/Compatibility**: PathogenFactory remains untouched, so existing entities (e.g., bosses) continue working. The new factories add overhead only for new enemy types, and they can be optimized separately (e.g., using instancing for SupportVector swarms).

- **Potential Conflicts or Overlaps**:
  - If a new enemy type (e.g., a Mutagen) needs advanced pathogen-like features, we could extend `createGroupedMeshes` or import from PathogenFactory, but currently, they're kept separate to avoid coupling.
  - Roster data now includes `specId` for Infection/Support Vectors, which could tie into `CreatureFactory.tsx` (a separate system for animal models), not PathogenFactory.

#### Do We Need Similar but Separate Factories and AvatarTuner Controls?
Yes, for the new proposed approach (separate factories per enemy type), we should have **similar but separate factories** and **AvatarTuner-like controls** to maintain modularity and tuning capabilities. Here's why and how:

- **Separate Factories**:
  - **Why?** Each enemy type (Pathogens, Mutagens, Infection Vectors, Support Vectors) has unique requirements:
    - Pathogens: Complex, spiky meshes (already handled by PathogenFactory and our new Pathogen.jsx).
    - Mutagens: Molecular structures with specific attack patterns (e.g., lasers for UV Radiation)—our Mutagen.jsx is a basic start, but it could grow into a full factory like PathogenFactory.
    - Infection Vectors: Animal-like models (integrate with `CreatureFactory.tsx` for procedural insects/mammals).
    - Support Vectors: Swarm-friendly, instanced meshes (focus on performance for allies).
  - **How?** Keep them as separate `.jsx` files (as we did), each with their own procedural logic. For example:
    - Expand Mutagen.jsx to include a `MutagenFactory.tsx` (similar to PathogenFactory) for advanced specs (e.g., laser beam parameters).
    - InfectionVector.jsx could dispatch to `CreatureFactory.tsx` for `specId`-based models.
    - This avoids bloating PathogenFactory and allows type-specific optimizations (e.g., MutagenFactory for molecular animations).

- **AvatarTuner-Like Controls**:
  - **Why?** AvatarTuner is essential for tweaking procedural visuals without code changes. Without similar tools, tuning new enemy types (e.g., adjusting UV Radiation's star points or Benzene's ring size) would be manual and error-prone. It also helps match designs to roster data.
  - **How?** Create separate tuner pages or extend AvatarTuner:
    - **Option 1: Extend AvatarTuner**: Add tabs or selectors for enemy type (e.g., "Pathogen", "Mutagen"). When "Mutagen" is selected, show sliders for Mutagen-specific props (e.g., star points for UV, ring radius for Benzene). Export specs to roster or JSON files.
    - **Option 2: Separate Tuners**: Create `MutagenTuner.tsx`, `InfectionVectorTuner.tsx`, etc., mirroring AvatarTuner's structure. Each would use the respective factory (e.g., `MutagenTuner` uses Mutagen.jsx or a future `MutagenFactory`).
    - **Integration**: Tuners should output specs that can be plugged into roster.js (e.g., update `vfx` or add custom fields). For Infection/Support Vectors, integrate with `CreatureFactory.tsx`'s avatar tuning (as mentioned in CREATURE_FACTORY_CONTEXT.md).
    - **Example Workflow**: In `MutagenTuner`, adjust "beam count" for UV Radiation, preview the 10-pointed star with lasers, and export a spec that Mutagen.jsx uses for rendering.

- **Recommendations**:
  - Start with extending AvatarTuner for Mutagens (since they're detailed in the prompt).
  - Ensure tuners use the same pattern as AvatarTuner: live preview, sliders, and spec export.
  - This keeps the "separate concerns" goal—PathogenFactory stays for pathogens, new factories/tuners for others.

If we proceed, I can implement a basic extension to AvatarTuner for Mutagens next. Let me know if you'd like to adjust the plan!

## Current State Analysis
- `roster.js` has been revised with new entries for Infection Vectors (bosses) and Support Vectors (allies), including `specId` for procedural mapping.
- Existing entities like `TriangleBoss.jsx` and `PipeBoss.jsx` provide reference attack patterns.
- `SnakePathogen.jsx` exists as a grouped meshes procedural; it will be absorbed into `Pathogen.jsx`.
- No existing factory structure; entities are likely instantiated directly. New factories will act as dispatchers for procedural creation.
- Game uses Three.js for rendering; factories should output Three.js meshes/groups.

## Proposed Changes
### 1. File Structure and Creation
- **New Files to Create:**
  - Pathogen.jsx: Factory for Pathogen enemies (e.g., MRSA, VRE). Integrates SnakePathogen as a variant. Uses grouped meshes procedural for complex shapes.
  - `src/characters/Mutagen.jsx`: Factory for Mutagen enemies (UV Radiation, Benzene, X-Rays, Nitrosamines). Implements specific designs and attack patterns.
  - `src/characters/InfectionVector.jsx`: Factory for Infection Vector bosses (e.g., Broodmother Cockroach). Uses grouped meshes procedural.
  - `src/characters/SupportVector.jsx`: Factory for Support Vector allies (e.g., Honeybee Medics). Procedural but non-hostile.

- **Files to Modify:**
  - SnakePathogen.jsx: Deprecate and remove after integration into `Pathogen.jsx`.
  - roster.js: Ensure all new entries are present (already revised per context).
  - Any entity instantiation logic (e.g., in game loops or spawners): Update to use new factories instead of direct imports.

- **Existing Files to Reference (No Changes):**
  - TriangleBoss.jsx: For Benzene's attack pattern (spinning, spewing smoke/fire).
  - PipeBoss.jsx: For X-Rays' stationary behavior and laser emission.
  - `src/characters/factory/CreatureFactory.tsx` and related (from CREATURE_FACTORY_CONTEXT.md): For InfectionVector and SupportVector procedural specs.

### 2. Factory Design Principles
- **Base Structure:** Each factory is a React component (matching existing `.jsx` files) that takes props like `enemyData` (from roster) and returns a Three.js `group` or `mesh`.
- **Procedural Generation:** Use roster data (shape, color, stats) to generate meshes dynamically. For grouped meshes (e.g., SnakePathogen style), create composite objects with multiple sub-meshes.
- **Shared Procedural Logic:** Implement a helper function (e.g., `createGroupedMeshes`) in a shared utility (new file: `src/characters/ProceduralUtils.js`) for Pathogen, Mutagen, and InfectionVector.
- **Attack Patterns:** Integrate behaviors via Three.js animations, event listeners, or game context updates. Use existing patterns as references.
- **Performance:** Pool geometries/materials, use instancing where possible (e.g., for swarms in SupportVector).
- **Integration:** Factories dispatch based on `type` in roster (e.g., 'Pathogen' → Pathogen.jsx). Support Vectors are allies, so non-damaging.

### 3. Detailed Implementation per Factory
#### Pathogen.jsx
- **Entities:** All 'Pathogen' types from roster (e.g., MRSA, E. coli).
- **Integration:** Absorb `SnakePathogen.jsx` as a conditional variant (if `name` includes 'Snake' or specific flag).
- **Procedural:** Use grouped meshes for complex shapes (e.g., segmented bodies). Base on shape/color from roster.
- **Attack Patterns:** Generic (e.g., movement, basic hits); no special overrides unless specified in roster.

#### Mutagen.jsx
- **Entities:** UV Radiation, Benzene, X-Rays, Nitrosamines.
- **Procedural Designs:**
  - **UV Radiation:** 10-pointed star mesh with glowing "holy white-subtle blue" material. Hovers and shoots 3 alternating laser beams (4s duration, non-linear). Immortal; spawns for 4 waves then despawns.
  - **Benzene:** Molecule structure (ring shape) that glides, spins, and spews toxic smoke/fire. Attack pattern: Reference TriangleBoss (radial bursts).
  - **X-Rays:** Flashlight-shaped mesh, stationary. Shoots slow lasers (1 damage/tick + status effects). Reference PipeBoss for positioning/emission.
  - **Nitrosamines:** Molecule structure that roams slowly. Agitated attack: Two smoke-fire projectiles toward player. Destroys power-ups on collision.
- **Procedural:** Use grouped meshes for molecular structures. Apply roster colors/stats.
- **Attack Patterns:** Custom animations/behaviors as described.

#### InfectionVector.jsx
- **Entities:** 'Vector (Boss)' types from roster (e.g., Broodmother Cockroach).
- **Procedural:** Use grouped meshes for animal-like forms. Leverage `CreatureFactory.tsx` specs via `specId`.
- **Attack Patterns:** Based on roster `gameplayEffect` (e.g., spawns, AoE). Integrate with boss cadence.

#### SupportVector.jsx
- **Entities:** 'Ally' types from roster (e.g., Honeybee Medics).
- **Procedural:** Non-hostile; use grouped meshes or instancing for swarms. Leverage `CreatureFactory.tsx`.
- **Attack Patterns:** Support effects (e.g., healing auras); no damage.

### 4. Step-by-Step Implementation Plan
1. **Preparation (No Code Changes):**
   - Review `roster.js` for completeness.
   - Create `src/characters/ProceduralUtils.js` with shared helpers (e.g., `createGroupedMeshes`).

2. **Create Factories (Phase 1):**
   - Implement `Pathogen.jsx`: Integrate SnakePathogen, add procedural logic.
   - Implement `Mutagen.jsx`: Add specific designs and attack patterns.
   - Implement `InfectionVector.jsx`: Dispatch to CreatureFactory specs.
   - Implement `SupportVector.jsx`: Procedural allies.

3. **Update Instantiation Logic (Phase 2):**
   - Identify where enemies are spawned (e.g., game loop in game or contexts).
   - Replace direct entity imports with factory calls (e.g., `<Pathogen enemyData={data} />`).

4. **Integrate Attack Patterns (Phase 3):**
   - Add animation/behavior hooks in factories using Three.js or game context.
   - Test Mutagen specials against references.

5. **Deprecation (Phase 4):**
   - Remove `SnakePathogen.jsx` after integration.
   - Update any imports.

6. **Testing and Validation (Ongoing):**
   - Run `npm run dev` after each phase.
   - Test procedural generation: Spawn each entity type, verify visuals/stats.
   - Performance: 2-minute wave test; check FPS/draw calls.
   - Functionality: Ensure no breaks in existing waves/bosses.

### 5. Risks and Mitigation
- **Breaking Existing Code:** Isolate changes to new files; use feature flags or conditional logic in spawners. Test incrementally.
- **Performance Issues:** Cap concurrent entities; use LOD and pooling.
- **Inconsistent Behaviors:** Reference existing entities closely; document deviations.
- **Data Mismatches:** Validate roster fields in factories; add error handling.
- **Scope Creep:** Focus on factories first; defer UI/avatar tuning to later.

### 6. Timeline and Milestones
- **Week 1:** Planning complete; create ProceduralUtils and Pathogen.jsx.
- **Week 2:** Implement Mutagen.jsx and InfectionVector.jsx.
- **Week 3:** Implement SupportVector.jsx; update spawners.
- **Week 4:** Integration, testing, and cleanup.

### 7. Dependencies and Prerequisites
- Ensure `roster.js` is updated with all entries.
- Access to Three.js and existing entity files for references.
- No external libraries needed; use existing project setup.

## Implementation Progress
- **Phase 1 (Create Factories):** Completed
  - Created `ProceduralUtils.js` with shared `createGroupedMeshes` and `makeRng`.
  - Modified `Pathogen.jsx` to integrate `SnakePathogen.jsx` as a variant; renamed original component to `PathogenMesh` and added factory export.
  - Created `Mutagen.jsx` with specific designs for UV Radiation (10-pointed star), Benzene (ring), X-Rays (flashlight), Nitrosamines (rectangle molecule).
  - Created `InfectionVector.jsx` using grouped meshes (placeholder for CreatureFactory integration).
  - Created `SupportVector.jsx` using grouped meshes for allies.
- **Phase 2 (Update Instantiation Logic):** Completed
  - Modified `RosterEnemy.jsx` to accept `enemyData` prop and dispatch to new factories (`Pathogen`, `Mutagen`, `InfectionVector`) based on `type`.
  - Updated `App.jsx` to pass `enemyData` (roster entry) to `RosterEnemy` instances.
  - Roster enemies now use procedural factories instead of `PathogenFromSpec` for Pathogens and Mutagens.
- **Next Steps:** Phase 3 - Integrate attack patterns (animations/behaviors) in factories using Three.js or game context. Test Mutagen specials against references.

This plan ensures safe, modular implementation. Proceed to implementation once approved, or revise as needed.